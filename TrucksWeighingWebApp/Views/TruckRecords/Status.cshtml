@model TrucksWeighingWebApp.ViewModels.TruckRecordPierIndexViewModel

@{
    ViewData["Title"] = "Trucks Status";
    // string T(DateTime? dt) => dt.HasValue ? dt.Value.ToLocalTime().ToString("HH:mm") : "-";
    string TD(DateTime? dt) => dt.HasValue ? dt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm") : "-";
    string D(TimeSpan? ts) => ts.HasValue ?
        (ts.Value.TotalHours >=24
            ? $"{(int)ts.Value.TotalDays}d {ts.Value:hh\\:mm}"
            : ts.Value.ToString(@"hh\:mm"))
        : "-";
}


<div class="row">
    <div class="col-7">
        <h1 id="anchor-trucks-status">Trucks Status</h1>
    </div>
    <div class="col-5 d-flex justify-content-end align-items-center">
        <a href="@Url.Action("Index", "TruckRecords", new { inspectionId = Model.Inspection.Id })#anchor-results">Results</a>        
    </div>
</div>
<hr />

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb small mb-0">
        <li class="breadcrumb-item">
            <a asp-controller="Inspections" asp-action="Index">Inspections</a>
        </li>
        <li class="breadcrumb-item">
            <a asp-controller="TruckRecords" asp-action="Index" asp-route-inspectionId="@Model.Inspection.Id">Trucks List</a>            
        </li>
        <li class="breadcrumb-item active" aria-current="page">Trucks Status</li>
    </ol>
</nav>

@if (TempData["msgStartCargoOperations"] is string msgStartCargoOperations)
{
    <div class="alert alert-warning mt-2">
        @msgStartCargoOperations
    </div>
}

@if (TempData["msgCompleteCargoOperations"] is string msgCompleteCargoOperations)
{
    <div class="alert alert-warning mt-2">
        @msgCompleteCargoOperations
    </div>
}


<h5>
    <span>
        @Model.AfterInitialWeighingToCargoOps.Count truck@(Model.AfterInitialWeighingToCargoOps.Count == 1 ? "" : "s"):
    </span>

    <span class="d-none d-sm-inline">
        Initial Weighing -> Cargo Operations
    </span>
    <span class="d-inline d-sm-none">
        Initial Weighing -> Cargo Ops
    </span>
</h5>
<div class="table-responsive mb-3">
    <table class="table">
        <thead>
            <tr class="text-nowrap">
                <th>#</th>
                <th>Plate Number</th>
                <th>Initial Weighing</th>
                <th>Started</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.AfterInitialWeighingToCargoOps)
            {
                <tr class="text-nowrap">
                    <td>@item.SerialNumber</td>
                    <td>@item.PlateNumber</td>
                    <td>@TD(item.InitialWeightAtUtc)</td>
                    <td>
                        <form asp-action="StartCargoOperations" method="post">
                            @Html.AntiForgeryToken()                            
                            <input type="hidden" name="id" value="@item.Id"/>
                            <div class="form-check form-switch">
                                <input class="form-check-input"
                                       type="checkbox"
                                       title="Start"
                                       onchange="const cb=this; cb.disabled=true; setTimeout(() => this.closest('form').submit(), 600)"
                                       @(item.InitialWeightAtUtc == null ? "disabled" : null) />
                            </div>                            
                        </form>
                    </td>
                </tr>
            }
            @if (!Model.AfterInitialWeighingToCargoOps.Any())
            {
                <tr class="text-nowrap">
                    <td colspan="4" class="text-center text-muted">No trucks</td>
                </tr>
            }
        </tbody>
    </table>
</div>


<h5>
    <span>
        @Model.UnderCargoOperations.Count truck@(Model.UnderCargoOperations.Count == 1 ? "" : "s"):
    </span>

    <span class="d-none d-sm-inline">
        under Cargo Operations
    </span>
    <span class="d-inline d-sm-none">
        under Cargo Ops
    </span>
</h5>
<div class="table-responsive mb-3">
    <table class="table">
        <thead>
            <tr class="text-nowrap">
                <th>#</th>
                <th>Plate Number</th>
                <th>Started</th>
                <th>Finished</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.UnderCargoOperations)
            {
                <tr class="text-nowrap">
                    <td>@item.SerialNumber</td>
                    <td>@item.PlateNumber</td>
                    <td>@TD(item.InitialBerthAtUtc)</td>
                    <td>
                        <form asp-action="CompleteCargoOperations" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@item.Id"/>
                            <div class="form-check form-switch">
                                <input class="form-check-input"
                                       type="checkbox"
                                       title="Finish"
                                       onchange="const cb=this; cb.disabled=true; setTimeout(() => this.closest('form').submit(), 600)"
                                       @(item.InitialBerthAtUtc == null ? "disabled" : null) />
                            </div>
                        </form>
                    </td>
                </tr>
            }
            @if (!Model.UnderCargoOperations.Any())
            {
                <tr class="text-nowrap">
                    <td colspan="4" class="text-center text-muted">No trucks</td>
                </tr>
            }
        </tbody>
    </table>
</div>


<h5>
    <span>
        @Model.AfterCargoOpsToFinalWeighing.Count truck@(Model.AfterCargoOpsToFinalWeighing.Count == 1 ? "" : "s"):
    </span>

    <span class="d-none d-sm-inline">
        Cargo Operations -> Final Weighing
    </span>
    <span class="d-inline d-sm-none">
        Cargo Ops -> Final Weighing
    </span>
</h5>

<div class="table-responsive mb-3">
    <table class="table">
        <thead>
            <tr class="text-nowrap">
                <th>#</th>
                <th>Plate Number</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.AfterCargoOpsToFinalWeighing)
            {
                <tr class="text-nowrap">
                    <td>@item.SerialNumber</td>
                    <td>@item.PlateNumber</td>
                </tr>
            }
            @if (!Model.AfterCargoOpsToFinalWeighing.Any())
            {
                <tr class="text-nowrap">
                    <td colspan="2" class="text-center text-muted">No trucks</td>
                </tr>
            }
        </tbody>
    </table>
</div>


<div class="row align-items-center mb-3">
    <div class="col-12 col-sm-6">
        <h5>@Model.TotalCount trucks: after Final Weighing</h5>
    </div>
    <div class="col-12 col-sm-6">
        <!-- PAGINATION SELECT -->
        <div class="d-flex justify-content-end mb-2">
            <form method="get" class="mb-2 mt-2 d-flex gap-2 align-items-center justify-content-end">
                <input type="hidden" name="inspectionId" value="@Model.Inspection.Id" />
                <input type="hidden" name="page" value="1" />

                <label class="form-label m-0" for="pageSize">Trucks per page:</label>
                <select id="pageSize"
                        name="pageSize"
                        class="form-select form-select-sm"
                        style="width:auto"
                        onchange="this.form.submit()">
                    @foreach (var option in Model.PageSizeOptions)
                    {
                        <option value="@option.Value" selected="@(option.Value == Model.PageSize ? "selected" : null)">
                            @option.Label
                        </option>
                    }

                </select>
            </form>
        </div>
    </div>
</div>



<!-- MAIN TABLE -->
<div class="table-responsive mb-3">
    <table class="table table-hover">
        <thead>
            <tr class="text-nowrap">
                <th class="position-sticky top-0 bg-body z-2">#</th>
                <th class="position-sticky top-0 bg-body z-2">Plate Number</th>
                <th class="position-sticky top-0 bg-body z-2">Initial Weighing</th>
                <th class="position-sticky top-0 bg-body z-2"><small>Duration</small></th>
                <th class="position-sticky top-0 bg-body z-2">Cargo Operations Started</th>
                <th class="position-sticky top-0 bg-body z-2"><small>Duration</small></th>
                <th class="position-sticky top-0 bg-body z-2">Cargo Operations Finished</th>
                <th class="position-sticky top-0 bg-body z-2"><small>Duration</small></th>
                <th class="position-sticky top-0 bg-body z-2">Final Weighing</th>
                <th class="position-sticky top-0 bg-body z-2"><small>Duration</small></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.AfterFinalWeighing)
            {
                <tr class="text-nowrap">
                    <td>@item.SerialNumber</td>
                    <td>@item.PlateNumber</td>
                    <td>@TD(item.InitialWeighing)</td>
                    <td><div class="text-muted small">@D(item.DurationInitialWeighingToCargoOpsStarted)</div></td>
                    <td>@TD(item.CargoOpsStarted)</td>
                    <td><div class="text-muted small">@D(item.DurationCargoOpsStartedToCargoOpsFinished)</div></td>
                    <td>@TD(item.CargoOpsFinished)</td>
                    <td><div class="text-muted small">@D(item.DurationCargoOpsFinishedToFinalWeighing)</div></td>
                    <td>@TD(item.FinalWeighing)</td>
                    <td><div class="text-muted small">@D(item.DurationTotal)</div></td>
                </tr>
            }
            @if (!Model.AfterFinalWeighing.Any())
            {
                <tr>
                    <td colspan="10" class="text-center text-muted">No trucks</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (Model.PageSize != TrucksWeighingWebApp.ViewModels.PageSizesTrucksStatus.All && Model.TotalPages > 1)
{
    var window = 2;
    var start = Math.Max(1, Model.Page - window);
    var end = Math.Min(Model.TotalPages, Model.Page + window);

    <nav aria-label="After-final pagination" class="mt-3">
        <ul class="pagination justify-content-center">
            
            <li class="page-item @(Model.Page == 1 ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Status"
                   asp-route-inspectionId="@Model.Inspection.Id"
                   asp-route-page="1"
                   asp-route-pageSize="@Model.PageSize">
                    First
                </a>
            </li>

            <li class="page-item @(Model.Page == 1 ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Status"
                   asp-route-inspectionId="@Model.Inspection.Id"
                   asp-route-page="@(Model.Page - 1)"
                   asp-route-pageSize="@Model.PageSize">
                    Prev
                </a>
            </li>


            @for (var p = start; p<= end; p++)
            {
                <li class="page-item @(p == Model.Page ? "active" : "")">
                    <a class="page-link"
                       asp-action="Status"
                       asp-route-inspectionId="@Model.Inspection.Id"
                       asp-route-page="@p"
                       asp-route-pageSize="@Model.PageSize">
                        @p
                    </a>
                </li>
            }



            <li class="page-item @(Model.Page == Model.TotalPages ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Status"
                   asp-route-inspectionId="@Model.Inspection.Id"
                   asp-route-page="@(Model.Page + 1)"
                   asp-route-pageSize="@Model.PageSize">
                    Next
                </a>
            </li>

            <li class="page-item @(Model.Page == Model.TotalPages ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Status"
                   asp-route-inspectionId="@Model.Inspection.Id"
                   asp-route-page="@Model.TotalPages"
                   asp-route-pageSize="@Model.PageSize">
                    Last
                </a>
            </li>

        </ul>
    </nav>
}

<a href="#anchor-trucks-status">To the top</a>